name: Testing
on:
  push:
    paths:
      - "src/**"

env:
  DOTNET_VERSION: 8.0.x

jobs:
  bundle_apps:
    name: Bundle Apps
    runs-on: ubuntu-latest
    outputs:
      names: ${{ steps.list.outputs.result }}
    steps:
      - uses: actions/checkout@v4

      - name: List apps
        id: list
        working-directory: src/apps
        run: |
          result=$(find . -maxdepth 1 -type d -not -path '.' -printf '%P\n' | jq -R -s -c 'split("\n")[:-1]')
          echo "result=$result" >> $GITHUB_OUTPUT

  ci:
    name: CI
    runs-on: ubuntu-latest
    needs: bundle_apps
    strategy:
      matrix:
        name: ${{ fromJson(needs.bundle_apps.outputs.names) }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: ${{ env.DOTNET_VERSION }}

      - name: Build
        working-directory: src/apps/${{ matrix.name }}
        run: dotnet build

      - name: Test
        if: always()
        working-directory: src/apps/${{ matrix.name }}
        run: dotnet test --no-build
